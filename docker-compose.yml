version: '3'
# Reach Digital - Magento 2 Docker development environment

services:
  hitch:
    image: zazukoians/hitch
    ports:
      - 443:443
    volumes:
      - ./hitch/*.localhost.reachdigital.io.pem:/etc/ssl/hitch/combined.pem:ro
    environment:
      HITCH_PARAMS: --backend=[varnish]:80 --frontend=[*]:443 --alpn-protos="h2,http/1.1" --write-proxy

  # bin/magento setup:config:set --http-cache-hosts=127.0.0.1:6081
  varnish:
    image: hermsi/alpine-varnish
    volumes:
      - ./varnish/default.vcl:/etc/varnish/default.vcl:ro
    ports:
      - 6081:6081
    environment:
      VARNISH_PORT: 80,PROXY
      VARNISHD_ADDITIONAL_OPTS: -p feature=+http2 -a :6081
      VARNISHLOG: 'true'
    depends_on:
      - nginx

  # TODO Replace FPM_ROOT with relative path
  nginx:
    image: nginx:alpine
    volumes:
      - ./nginx/conf.d/default.conf:/etc/nginx/conf.d/default.template:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ../src:/var/www/data:ro
    environment:
      FPM_PORT: 9000
      FPM_ROOT: '/Users/paulhachmang/Sites/iosr/src/pub'
    command: /bin/sh -c "envsubst '$$FPM_PORT $$FPM_ROOT' < /etc/nginx/conf.d/default.template > /etc/nginx/conf.d/default.conf && exec nginx -g 'daemon off;'"

  db:
    image: percona:5.7
    ports:
      - 3306:3306
    environment: 
      MYSQL_ROOT_PASSWORD: magento
      MYSQL_DATABASE: magento
      MYSQL_USER: magento
      MYSQL_PASSWORD: magento
    volumes:
      - ./.mysqldata:/var/lib/mysql

  # php bin/magento setup:config:set --cache-backend=redis --cache-backend-redis-db=0 --cache-backend-redis-port=6379
  # php bin/magento setup:config:set --session-save=redis --session-save-redis-db=2 --session-save-redis-port=6379
  redis:
    image: redis:5-alpine
    ports:
      - 6379:6379

  # bin/magento config:set --lock-config catalog/search/enable_eav_indexer 0
  # bin/magento config:set --lock-config catalog/search/engine [elasticsearch6 OR  elasticsuite]
  # bin/magento config:set --lock-env catalog/search/elasticsearch6_server_port 9200
  # bin/magento config:set --lock-env catalog/search/elasticsearch6_server_hostname localhost
  elasticsearch:
    build: ./elasticsearch
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - ./.esdata:/usr/share/elasticsearch/data

  # composer require mageplaza/module-smtp
  # php bin/magento setup:upgrade
  # bin/magento config:set --lock-env system/smtp/disable 0
  # bin/magento config:set --lock-env system/smtp/host localhost
  # bin/magento config:set --lock-env system/smtp/port 1025
  # http://localhost:8025/
  mailhog:
    image: mailhog/mailhog:v1.0.0
    ports:
      - "1025:1025"
      - "8025:8025"

  # bin/magento setup:config:set --amqp-host=localhost --amqp-port=5672 --amqp-user=guest --amqp-password=guest
  # http://localhost:15672
  rabbitmq:
    image: rabbitmq:3-management-alpine
    ports:
      - "5672:5672"
      - "15672:15672"
